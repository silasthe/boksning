<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Adaptive Boxing Trainer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: dark;
      --bg: #05070b;
      --card: #111827;
      --card-soft: #0b1220;
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.12);
      --accent-strong: rgba(59, 130, 246, 0.24);
      --border: #1f2937;
      --text: #f9fafb;
      --muted: #9ca3af;
      --danger: #ef4444;
      --easy: #22c55e;
      --hard: #f97316;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #111827 0, #020617 50%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .app-wrapper {
      width: 100%;
      max-width: 960px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .app-title {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .badge {
      font-size: 0.65rem;
      text-transform: uppercase;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--accent-strong);
      background: rgba(15, 23, 42, 0.8);
      color: var(--accent);
    }

    .nav {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .nav button {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.8rem;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.8);
      color: var(--muted);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .nav button.nav-active {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: var(--accent-strong);
    }

    .nav button:hover {
      border-color: var(--accent);
    }

    .user-label {
      font-size: 0.8rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .user-label span {
      font-weight: 600;
      color: var(--text);
    }

    .chip {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.7rem;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      background: radial-gradient(circle at top left, #111827 0, #020617 60%);
      border-radius: 16px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.85);
      padding: 16px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .section-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1fr);
      gap: 12px;
    }

    @media (max-width: 720px) {
      .section-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    label {
      font-size: 0.8rem;
      color: var(--muted);
      display: block;
      margin-bottom: 4px;
    }

    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      font-size: 0.9rem;
    }

    input[type="text"]::placeholder {
      color: #6b7280;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 500;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: white;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border-radius: 999px;
      border: 1px solid var(--border);
    }

    .btn-ghost:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn-easy {
      background: rgba(34, 197, 94, 0.12);
      color: var(--easy);
      border: 1px solid rgba(34, 197, 94, 0.4);
    }

    .btn-just {
      background: rgba(59, 130, 246, 0.12);
      color: var(--accent);
      border: 1px solid rgba(59, 130, 246, 0.4);
    }

    .btn-hard {
      background: rgba(249, 115, 22, 0.12);
      color: var(--hard);
      border: 1px solid rgba(249, 115, 22, 0.4);
    }

    .pill-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .pill {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .pill-dot-muted {
      background: #6b7280;
    }

    .gear-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }

    .gear-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--muted);
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
      width: fit-content;
    }

    .gear-item input {
      accent-color: var(--accent);
    }

    .difficulty-slider {
      margin-top: 6px;
    }

    .difficulty-slider input[type="range"] {
      width: 100%;
    }

    .difficulty-line {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .timer {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 2.2rem;
      font-weight: 700;
      letter-spacing: 0.12em;
    }

    .timer-label {
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .training-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .combo-box {
      margin-top: 12px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--accent-strong);
      background: radial-gradient(circle at top left, var(--accent-soft) 0, #020617 60%);
    }

    .combo-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .combo-numbers {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .combo-text {
      font-size: 0.9rem;
      color: var(--text);
    }

    .combo-count {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 6px;
    }

    .feedback-panel {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px dashed var(--border);
      display: none;
    }

    .feedback-panel.visible {
      display: block;
    }

    .feedback-title {
      font-size: 0.85rem;
      margin-bottom: 6px;
      color: var(--muted);
    }

    .feedback-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--muted);
      max-height: 240px;
      overflow-y: auto;
    }

    .history-item {
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(31, 41, 55, 0.9);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .history-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .history-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .history-tag {
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.7rem;
    }

    .history-tag-easy {
      border-color: var(--easy);
      color: var(--easy);
    }

    .history-tag-hard {
      border-color: var(--hard);
      color: var(--hard);
    }

    .muted {
      color: var(--muted);
    }

    .text-accent {
      color: var(--accent);
    }

    .text-easy {
      color: var(--easy);
    }

    .text-hard {
      color: var(--hard);
    }

    .hidden {
      display: none !important;
    }

    .login-layout {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 320px;
    }

    .login-hint {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .divider {
      border-top: 1px dashed var(--border);
      margin: 8px 0;
    }
  </style>
</head>
<body>
<div class="app-wrapper">

  <header class="app-header">
    <div class="app-title">
      ü•ä Adaptive Boxing Trainer
      <span class="badge">local only</span>
    </div>
    <div class="nav">
      <button id="nav-login" class="nav-active">Login</button>
      <button id="nav-settings">Settings</button>
      <button id="nav-training">Training</button>
      <button id="nav-logout" class="btn-ghost" style="padding: 4px 10px; font-size: 0.75rem;">Logout</button>
    </div>
  </header>

  <main>
    <!-- LOGIN VIEW -->
    <section id="view-login" class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Login / Sign-up</div>
          <div class="card-subtitle">User accounts are stored in your browser using localStorage.</div>
        </div>
      </div>
      <div class="login-layout">
        <div>
          <label for="username-input">Username</label>
          <input id="username-input" type="text" placeholder="e.g. silas_boxing">
        </div>
        <button id="btn-login" class="btn btn-primary">Enter gym</button>
        <div class="login-hint">
          If the username does not exist, a new profile will be created automatically.
          No passwords, no server ‚Äì everything is saved only in this browser.
        </div>
      </div>
    </section>

    <!-- MAIN GRID: SETTINGS + TRAINING+HISTORY -->
    <section id="main-grid" class="section-grid hidden">

      <!-- SETTINGS CARD -->
      <section id="view-settings" class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Settings</div>
            <div class="card-subtitle">Gear & difficulty for the current user.</div>
          </div>
          <div class="user-label">
            User:
            <span id="settings-current-user">‚Äì</span>
          </div>
        </div>

        <div>
          <strong style="font-size:0.8rem;">Gear</strong>
          <div class="gear-row">
            <label class="gear-item">
              <input type="checkbox" id="gear-gloves">
              <span>Boxing gloves</span>
            </label>
            <label class="gear-item">
              <input type="checkbox" id="gear-bag">
              <span>Heavy bag</span>
            </label>
            <label class="gear-item">
              <input type="checkbox" id="gear-weights">
              <span>Weights (dumbbells etc.)</span>
            </label>
          </div>
        </div>

        <div class="divider"></div>

        <div>
          <strong style="font-size:0.8rem;">Difficulty</strong>
          <div class="difficulty-slider">
            <label for="difficulty-slider">
              Current level:
              <span id="difficulty-value" class="text-accent">‚Äì</span> / 10
            </label>
            <input type="range" id="difficulty-slider" min="1" max="10" value="3">
          </div>

          <div id="difficulty-preview" class="difficulty-line">
            <!-- Filled by JS -->
          </div>

          <div class="pill-group" style="margin-top:8px;">
            <div class="pill">
              <span class="pill-dot"></span>
              <span id="preview-combo-length">Combos: ‚Äì</span>
            </div>
            <div class="pill">
              <span class="pill-dot pill-dot-muted"></span>
              <span id="preview-pace">Pace: ‚Äì</span>
            </div>
            <div class="pill">
              <span class="pill-dot pill-dot-muted"></span>
              <span id="preview-round">Round: ‚Äì</span>
            </div>
          </div>
        </div>
      </section>

      <!-- TRAINING + HISTORY CARD -->
      <section class="card">

        <!-- TRAINING VIEW -->
        <section id="view-training">
          <div class="card-header">
            <div>
              <div class="card-title">Training</div>
              <div class="card-subtitle" id="training-subtitle">Login to start a round.</div>
            </div>
            <div class="timer-block">
              <div class="timer-label">Round timer</div>
              <div class="timer" id="round-timer">00:00</div>
            </div>
          </div>

          <div class="training-meta">
            <div class="chip" id="training-gear-label">No user</div>
            <div class="chip" id="training-difficulty-label">Difficulty: ‚Äì</div>
            <div class="chip" id="training-mode-label">Mode: ‚Äì</div>
          </div>

          <div class="combo-box" id="combo-box">
            <div class="combo-label">Current combo</div>
            <div class="combo-numbers" id="combo-numbers">‚Äì</div>
            <div class="combo-text" id="combo-text">Press ‚ÄúStart round‚Äù to generate combos.</div>
            <div class="combo-count" id="combo-count">Combos this round: 0</div>
          </div>

          <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
            <button id="btn-start-round" class="btn btn-primary" disabled>Start round</button>
            <button id="btn-stop-round" class="btn btn-ghost" disabled>Stop</button>
          </div>

          <div class="feedback-panel" id="feedback-panel">
            <div class="feedback-title">How did that round feel?</div>
            <div class="feedback-buttons">
              <button class="btn btn-easy" data-feedback="easy">Too easy</button>
              <button class="btn btn-just" data-feedback="just">Just right</button>
              <button class="btn btn-hard" data-feedback="hard">Too hard</button>
            </div>
            <div class="difficulty-line" id="feedback-note"></div>
          </div>

          <div class="difficulty-line" style="margin-top:10px;">
            Combos are generated with simple rules: open with jabs/lead punches, avoid back-to-back heavy right-side power shots (2,4,6,8,10), but allow repeated jabs/feints.
          </div>
        </section>

        <div class="divider" style="margin-top:14px;"></div>

        <!-- HISTORY VIEW -->
        <section id="view-history">
          <div class="card-header" style="margin-bottom:4px;">
            <div>
              <div class="card-title" style="font-size:0.95rem;">History</div>
              <div class="card-subtitle">Last sessions for this user.</div>
            </div>
          </div>
          <ul id="history-list" class="history-list"></ul>
          <div id="history-empty" class="muted" style="font-size:0.8rem; margin-top:4px;">
            No rounds logged yet.
          </div>
        </section>

      </section>
    </section>
  </main>
</div>

<script>
  // Storage key for all users
  const STORAGE_KEY = 'boxingTrainerUsers_v1';

  // All in-memory users, loaded from localStorage
  let users = {};
  let currentUser = null;

  // Training state
  let roundIntervalId = null;
  let comboIntervalId = null;
  let currentRoundRemaining = 0;
  let currentDifficultyConfig = null;
  let combosThisRound = 0;

  // Punch mapping for display & speech
  const punchMap = {
    1: 'jab',
    2: 'cross',
    3: 'left hook',
    4: 'right hook',
    5: 'left body shot',
    6: 'right body shot',
    7: 'left uppercut',
    8: 'right uppercut',
    9: 'left low jab',
    10: 'right low jab'
  };

  const rightPower = [2, 4, 6, 8, 10];
  const allPunches = [1,2,3,4,5,6,7,8,9,10];

  // DOM references
  const navLogin = document.getElementById('nav-login');
  const navSettings = document.getElementById('nav-settings');
  const navTraining = document.getElementById('nav-training');
  const navLogout = document.getElementById('nav-logout');

  const viewLogin = document.getElementById('view-login');
  const mainGrid = document.getElementById('main-grid');
  const viewSettings = document.getElementById('view-settings');
  const viewTraining = document.getElementById('view-training');

  const usernameInput = document.getElementById('username-input');
  const btnLogin = document.getElementById('btn-login');

  const settingsCurrentUser = document.getElementById('settings-current-user');

  const gearGloves = document.getElementById('gear-gloves');
  const gearBag = document.getElementById('gear-bag');
  const gearWeights = document.getElementById('gear-weights');

  const difficultySlider = document.getElementById('difficulty-slider');
  const difficultyValue = document.getElementById('difficulty-value');
  const difficultyPreview = document.getElementById('difficulty-preview');

  const previewComboLength = document.getElementById('preview-combo-length');
  const previewPace = document.getElementById('preview-pace');
  const previewRound = document.getElementById('preview-round');

  const trainingSubtitle = document.getElementById('training-subtitle');
  const roundTimerEl = document.getElementById('round-timer');
  const trainingGearLabel = document.getElementById('training-gear-label');
  const trainingDifficultyLabel = document.getElementById('training-difficulty-label');
  const trainingModeLabel = document.getElementById('training-mode-label');

  const comboNumbersEl = document.getElementById('combo-numbers');
  const comboTextEl = document.getElementById('combo-text');
  const comboCountEl = document.getElementById('combo-count');

  const btnStartRound = document.getElementById('btn-start-round');
  const btnStopRound = document.getElementById('btn-stop-round');

  const feedbackPanel = document.getElementById('feedback-panel');
  const feedbackButtons = feedbackPanel.querySelectorAll('button[data-feedback]');
  const feedbackNote = document.getElementById('feedback-note');

  const historyList = document.getElementById('history-list');
  const historyEmpty = document.getElementById('history-empty');

  // Load users from localStorage
  function loadUsers() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      users = raw ? JSON.parse(raw) : {};
    } catch (e) {
      console.error('Failed to load users', e);
      users = {};
    }
  }

  function saveUsers() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(users));
  }

  // Create a new user object
  function createUser(username) {
    return {
      username,
      gear: {
        gloves: true,
        bag: false,
        weights: false
      },
      difficultyLevel: 3,
      history: []
    };
  }

  // Clamp difficulty to [1, 10]
  function clampDifficulty(level) {
    let l = parseInt(level, 10);
    if (Number.isNaN(l)) l = 3;
    if (l < 1) l = 1;
    if (l > 10) l = 10;
    return l;
  }

  // Derive parameters from difficulty level
  function getDifficultyConfig(level) {
    const l = clampDifficulty(level);
    let comboMin, comboMax;
    if (l <= 3) {
      comboMin = 2;
      comboMax = 3;
    } else if (l <= 6) {
      comboMin = 3;
      comboMax = 4;
    } else if (l <= 8) {
      comboMin = 4;
      comboMax = 5;
    } else {
      comboMin = 5;
      comboMax = 6;
    }

    // Pace: 4s -> ~1.6s as difficulty increases
    let paceSec = 4 - (l - 1) * 0.25;
    paceSec = Math.max(1.6, Math.min(4, paceSec));

    // Round length: 90s -> 180s
    const roundSec = 90 + (l - 1) * 10;

    return { level: l, comboMin, comboMax, paceSec, roundSec };
  }

  // Update difficulty preview UI
  function updateDifficultyPreview(level) {
    const cfg = getDifficultyConfig(level);
    difficultyPreview.textContent =
      `Level ${cfg.level}: ${cfg.comboMin}‚Äì${cfg.comboMax} punches per combo, ` +
      `${cfg.paceSec.toFixed(1)}s between combos, ${cfg.roundSec}s round.`;

    previewComboLength.textContent = `Combos: ${cfg.comboMin}‚Äì${cfg.comboMax} punches`;
    previewPace.textContent = `Pace: ~${cfg.paceSec.toFixed(1)}s between combos`;
    previewRound.textContent = `Round: ${cfg.roundSec} seconds`;
  }

  // History UI
  function updateHistoryUI() {
    if (!currentUser) {
      historyList.innerHTML = '';
      historyEmpty.classList.remove('hidden');
      return;
    }
    const hist = currentUser.history || [];
    if (!hist.length) {
      historyList.innerHTML = '';
      historyEmpty.classList.remove('hidden');
      return;
    }
    historyEmpty.classList.add('hidden');
    historyList.innerHTML = '';

    for (let i = hist.length - 1; i >= 0; i--) {
      const h = hist[i];
      const li = document.createElement('li');
      li.className = 'history-item';

      const main = document.createElement('div');
      main.className = 'history-main';

      const left = document.createElement('div');
      left.textContent = new Date(h.date).toLocaleString();
      const right = document.createElement('div');
      right.className = 'history-tags';

      const tagLevel = document.createElement('div');
      tagLevel.className = 'history-tag';
      tagLevel.textContent = `L${h.levelAfter}`;
      right.appendChild(tagLevel);

      const tagFeedback = document.createElement('div');
      let tfClass = 'history-tag';
      if (h.feedback === 'easy') tfClass += ' history-tag-easy';
      if (h.feedback === 'hard') tfClass += ' history-tag-hard';
      tagFeedback.className = tfClass;
      tagFeedback.textContent = h.feedback;
      right.appendChild(tagFeedback);

      main.appendChild(left);
      main.appendChild(right);

      const sub = document.createElement('div');
      sub.className = 'muted';
      sub.textContent = `${h.combos || 0} combos, ${h.roundSeconds || '?'}s round`;

      li.appendChild(main);
      li.appendChild(sub);
      historyList.appendChild(li);
    }
  }

  // Set current user and refresh UI
  function setCurrentUser(username) {
    currentUser = users[username];
    updateAllUIForUser();
  }

  function updateAllUIForUser() {
    if (!currentUser) {
      // Not logged in
      settingsCurrentUser.textContent = '‚Äì';
      trainingSubtitle.textContent = 'Login to start a round.';
      trainingGearLabel.textContent = 'No user';
      trainingDifficultyLabel.textContent = 'Difficulty: ‚Äì';
      trainingModeLabel.textContent = 'Mode: ‚Äì';
      roundTimerEl.textContent = '00:00';
      comboNumbersEl.textContent = '‚Äì';
      comboTextEl.textContent = 'Press ‚ÄúStart round‚Äù to generate combos.';
      comboCountEl.textContent = 'Combos this round: 0';
      historyList.innerHTML = '';
      historyEmpty.classList.remove('hidden');
      btnStartRound.disabled = true;
      btnStopRound.disabled = true;
      feedbackPanel.classList.remove('visible');
      return;
    }

    settingsCurrentUser.textContent = currentUser.username;

    gearGloves.checked = !!currentUser.gear.gloves;
    gearBag.checked = !!currentUser.gear.bag;
    gearWeights.checked = !!currentUser.gear.weights;

    const level = clampDifficulty(currentUser.difficultyLevel || 3);
    difficultySlider.value = String(level);
    difficultyValue.textContent = String(level);
    updateDifficultyPreview(level);

    trainingSubtitle.textContent = 'Press ‚ÄúStart round‚Äù for spoken combos.';
    trainingGearLabel.textContent = gearBag.checked ? 'Bag work' : 'Shadowboxing';
    trainingDifficultyLabel.textContent = `Difficulty: ${level} / 10`;
    trainingModeLabel.textContent = gearWeights.checked ? 'Weights: optional' : 'Weights: off';

    btnStartRound.disabled = false;
    btnStopRound.disabled = true;

    combosThisRound = 0;
    comboNumbersEl.textContent = '‚Äì';
    comboTextEl.textContent = 'Press ‚ÄúStart round‚Äù to generate combos.';
    comboCountEl.textContent = 'Combos this round: 0';
    feedbackPanel.classList.remove('visible');
    updateHistoryUI();
  }

  // UI navigation
  function setActiveNav(button) {
    [navLogin, navSettings, navTraining].forEach(btn => btn.classList.remove('nav-active'));
    button.classList.add('nav-active');
  }

  function showLoginView() {
    viewLogin.classList.remove('hidden');
    mainGrid.classList.add('hidden');
    setActiveNav(navLogin);
  }

  function showMainGrid(target) {
    if (!currentUser) {
      showLoginView();
      return;
    }
    viewLogin.classList.add('hidden');
    mainGrid.classList.remove('hidden');
    if (target === 'settings') {
      setActiveNav(navSettings);
    } else {
      setActiveNav(navTraining);
    }
  }

  // Format seconds as mm:ss
  function formatSeconds(sec) {
    const s = Math.max(0, Math.floor(sec));
    const m = Math.floor(s / 60);
    const rs = s % 60;
    return `${String(m).padStart(2,'0')}:${String(rs).padStart(2,'0')}`;
  }

  // Speak combo
  function speakCombo(combo) {
    if (!('speechSynthesis' in window)) return;
    const text = combo.map(id => punchMap[id]).join(', ');
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 1.1;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
  }

  // Generate a combo following rules
  function generateCombo(cfg) {
    const len = Math.floor(Math.random() * (cfg.comboMax - cfg.comboMin + 1)) + cfg.comboMin;
    const combo = [];
    // openers: jabs/lead/uppercut body shots
    const firstOptions = [1, 9, 3, 5, 7];
    combo.push(firstOptions[Math.floor(Math.random() * firstOptions.length)]);

    for (let i = 1; i < len; i++) {
      const prev = combo[i - 1];
      let allowed;
      if (rightPower.includes(prev)) {
        // After a right-side power shot, avoid another right-side power
        allowed = allPunches.filter(p => !rightPower.includes(p));
      } else {
        allowed = allPunches.slice();
      }
      const next = allowed[Math.floor(Math.random() * allowed.length)];
      combo.push(next);
    }
    return combo;
  }

  function showCombo(combo) {
    const nums = combo.join(' ‚Äì ');
    const text = combo.map(id => punchMap[id]).join(' ‚Äì ');
    comboNumbersEl.textContent = nums;
    comboTextEl.textContent = text;
    combosThisRound += 1;
    comboCountEl.textContent = `Combos this round: ${combosThisRound}`;
  }

  // Start a training round
  function startRound() {
    if (!currentUser) return;
    if (roundIntervalId || comboIntervalId) return;

    combosThisRound = 0;
    feedbackPanel.classList.remove('visible');
    currentDifficultyConfig = getDifficultyConfig(currentUser.difficultyLevel);

    currentRoundRemaining = currentDifficultyConfig.roundSec;
    roundTimerEl.textContent = formatSeconds(currentRoundRemaining);

    trainingSubtitle.textContent = 'Round in progress‚Ä¶';
    trainingDifficultyLabel.textContent = `Difficulty: ${currentDifficultyConfig.level} / 10`;

    btnStartRound.disabled = true;
    btnStopRound.disabled = false;

    // Timer tick
    roundIntervalId = setInterval(() => {
      currentRoundRemaining -= 1;
      if (currentRoundRemaining <= 0) {
        currentRoundRemaining = 0;
        roundTimerEl.textContent = formatSeconds(currentRoundRemaining);
        endRound('time');
      } else {
        roundTimerEl.textContent = formatSeconds(currentRoundRemaining);
      }
    }, 1000);

    // First combo immediately
    const combo = generateCombo(currentDifficultyConfig);
    showCombo(combo);
    speakCombo(combo);

    // Next combos based on pace
    comboIntervalId = setInterval(() => {
      if (!currentDifficultyConfig || currentRoundRemaining <= 0) return;
      const c = generateCombo(currentDifficultyConfig);
      showCombo(c);
      speakCombo(c);
    }, currentDifficultyConfig.paceSec * 1000);
  }

  // Stop round manually
  function stopRoundManual() {
    if (!currentUser) return;
    if (!roundIntervalId && !comboIntervalId) return;
    endRound('manual');
  }

  // End round, reason: 'time' or 'manual'
  function endRound(reason) {
    if (roundIntervalId) {
      clearInterval(roundIntervalId);
      roundIntervalId = null;
    }
    if (comboIntervalId) {
      clearInterval(comboIntervalId);
      comboIntervalId = null;
    }
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
    }

    btnStartRound.disabled = false;
    btnStopRound.disabled = true;

    if (!currentDifficultyConfig) return;

    if (reason === 'time') {
      trainingSubtitle.textContent = 'Round finished. Log your feedback.';
    } else {
      trainingSubtitle.textContent = 'Round stopped. Log your feedback if you want.';
    }

    feedbackNote.textContent =
      `You did ${combosThisRound} combos in ~${currentDifficultyConfig.roundSec}s at level ${currentDifficultyConfig.level}. Choose how it felt.`;
    feedbackPanel.classList.add('visible');
  }

  // Apply feedback: 'easy', 'just', 'hard'
  function applyFeedback(feedback) {
    if (!currentUser || !currentDifficultyConfig) return;

    let level = clampDifficulty(currentUser.difficultyLevel);
    if (feedback === 'easy') level = clampDifficulty(level + 1);
    if (feedback === 'hard') level = clampDifficulty(level - 1);

    currentUser.difficultyLevel = level;
    currentUser.history.push({
      date: new Date().toISOString(),
      feedback,
      levelAfter: level,
      combos: combosThisRound,
      roundSeconds: currentDifficultyConfig.roundSec
    });

    saveUsers();
    feedbackNote.textContent = `Saved feedback "${feedback}". Next rounds will use level ${level}.`;
    feedbackPanel.classList.remove('visible');
    updateAllUIForUser();
  }

  // Event listeners
  navLogin.addEventListener('click', () => {
    showLoginView();
  });

  navSettings.addEventListener('click', () => {
    showMainGrid('settings');
  });

  navTraining.addEventListener('click', () => {
    showMainGrid('training');
  });

  navLogout.addEventListener('click', () => {
    currentUser = null;
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
    }
    stopRoundManual();
    showLoginView();
    updateAllUIForUser();
  });

  btnLogin.addEventListener('click', () => {
    const username = usernameInput.value.trim();
    if (!username) return;
    loadUsers();
    if (!users[username]) {
      users[username] = createUser(username);
      saveUsers();
    }
    setCurrentUser(username);
    usernameInput.value = '';
    showMainGrid('training');
  });

  usernameInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      btnLogin.click();
    }
  });

  gearGloves.addEventListener('change', () => {
    if (!currentUser) return;
    currentUser.gear.gloves = gearGloves.checked;
    saveUsers();
  });

  gearBag.addEventListener('change', () => {
    if (!currentUser) return;
    currentUser.gear.bag = gearBag.checked;
    saveUsers();
    trainingGearLabel.textContent = gearBag.checked ? 'Bag work' : 'Shadowboxing';
  });

  gearWeights.addEventListener('change', () => {
    if (!currentUser) return;
    currentUser.gear.weights = gearWeights.checked;
    saveUsers();
    trainingModeLabel.textContent = gearWeights.checked ? 'Weights: optional' : 'Weights: off';
  });

  difficultySlider.addEventListener('input', () => {
    if (!currentUser) return;
    if (roundIntervalId || comboIntervalId) {
      difficultySlider.value = String(currentUser.difficultyLevel);
      return;
    }
    const level = clampDifficulty(difficultySlider.value);
    currentUser.difficultyLevel = level;
    difficultyValue.textContent = String(level);
    updateDifficultyPreview(level);
    trainingDifficultyLabel.textContent = `Difficulty: ${level} / 10`;
    saveUsers();
  });

  btnStartRound.addEventListener('click', () => {
    startRound();
  });

  btnStopRound.addEventListener('click', () => {
    stopRoundManual();
  });

  feedbackButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const fb = btn.dataset.feedback;
      applyFeedback(fb);
    });
  });

  window.addEventListener('beforeunload', () => {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
    }
  });

  // Initialise
  loadUsers();
  updateAllUIForUser();
  showLoginView();
</script>
</body>
</html>
